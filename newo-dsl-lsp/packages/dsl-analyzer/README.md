# @newo-dsl/analyzer

Core analysis library for Newo DSL templates (`.jinja`, `.guidance`). Used by both the LSP server and the CLI linter.

## Features

- **Jinja Parser** - Tokenizes Jinja templates into expressions, statements, and comments with proper handling of nested braces, strings, and multi-line content
- **Function Call Extraction** - Identifies skill calls, built-in calls, and unknown functions with parameter parsing
- **Schema Validation** - Validates function calls against loaded YAML schemas with typo suggestions via Levenshtein distance
- **Diagnostics** - Reports syntax errors (E001-E003), unknown skills (E100), and parameter issues (W101-W102)
- **IDE Support** - Provides completions, hover info, and go-to-definition data

## API Reference

### `NewoDslAnalyzer`

Main analyzer class providing all analysis capabilities.

```typescript
import { NewoDslAnalyzer } from '@newo-dsl/analyzer';

const analyzer = new NewoDslAnalyzer();
analyzer.loadSchemas('/path/to/schemas');

// Parse a template
const result = analyzer.parseTemplate(content, filePath);

// Get diagnostics
const diagnostics = analyzer.getDiagnostics(content, filePath);

// Get completions at position
const completions = analyzer.getCompletions(content, filePath, line, column);

// Get hover info
const hover = analyzer.getHover(content, filePath, line, column);

// Get definition location
const definition = analyzer.getDefinition(content, filePath, line, column);
```

### `JinjaParser`

Low-level Jinja template tokenizer and parser.

```typescript
import { JinjaParser } from '@newo-dsl/analyzer';

const parser = new JinjaParser();
const result = parser.parse(templateContent, 'template.jinja');
// result.functionCalls, result.variables, result.diagnostics, etc.
```

## Type Definitions

| Type | Description |
|------|-------------|
| `ParseResult` | Complete parse output with function calls, variables, blocks, diagnostics |
| `FunctionCall` | Extracted function call with name, type (skill/builtin/unknown), parameters |
| `Parameter` | Function parameter - keyword (`name=value`) or positional |
| `Diagnostic` | Error/warning with severity, code, message, range |
| `SchemaRegistry` | Maps of loaded skills, builtins, attributes, events |
| `CompletionItem` | Completion suggestion with label, kind, detail, insertText |
| `HoverInfo` | Hover documentation content |
| `DefinitionLocation` | Go-to-definition target URI and range |

## Diagnostic Codes

| Code | Severity | Description |
|------|----------|-------------|
| E001 | Error | Unbalanced expression braces `{{ }}` |
| E002 | Error | Unbalanced statement braces `{% %}` |
| E003 | Error | Unbalanced comment braces `{# #}` |
| E100 | Error | Unknown skill (not found in schema) |
| W101 | Warning | Unknown function (not a skill or built-in) |
| W102 | Warning | Unknown parameter for function |

## Schema Files

The analyzer loads schemas from YAML files generated by `@newo-dsl/spec-generator`:

| File | Content |
|------|---------|
| `skills.schema.yaml` | 1,218 skill definitions with typed parameters |
| `builtins.schema.yaml` | Built-in function definitions |
| `attributes.schema.yaml` | 314 customer/persona attributes |
| `events.schema.yaml` | 186 system event definitions |

## Development

```bash
# Build
npm run build

# Watch mode
npm run watch

# Run tests
npm test
```

## License

Proprietary - [Newo AI](https://newo.ai). All rights reserved.
